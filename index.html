<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#333333" />
  <meta name="author" content="Yao-Yuan Mao" />
  <meta name="creator" content="Yao-Yuan Mao" />
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-32378628-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-32378628-1');
  </script>

  <title>Cutout Image List Tool for DESI Legacy Imaging Surveys and More</title>
  <meta name="description"
  content="Display image cutouts for a list of sky coordinates, allowing you to inspect and mark selections. Images are retrived from DESI Legacy Imaging Surveys, SDSS, and DSS.">
  <meta name="keywords"
    content="astronomy, survey, cutout, image, imaging, photmetric, SDSS, DESI, DSS, DES, HSC, GALEX, WISE, DESI Legacy Imaging Surveys, target selection, javascript" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/2.0.6/base.min.css" integrity="sha512-LuNflZud8JqmAW51BErW7CwyrjuWqD/fqpekzJAFoUOJpZDEYFLhRPXYByNe8Yy9Z8IAJAe6Alqo0ivJXWv5Hw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/2.0.6/buttons.min.css" integrity="sha512-6fgfhyE9ySgHhLG/VlUzsLMAl5ASlf77G0KyTajPvyYXyMItY3h98gEX1Pnzjo3P2QjDQW4S95CX05ycHeiffQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/2.0.6/forms.min.css" integrity="sha512-rh8hys9VgPr84sRqt9OaFfOtGwy2i5E1FShkMZi9A6Rq5LO0oP3CGK3jPA4dXBnuVCjFG547uSz3/sio1K7R3Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
  #main{
    padding: 0.5em;
    max-width: 1000px;
    margin-left: auto;
    margin-right: auto;
    margin-bottom: 200px;
  }
  #form{
    max-width: 960px;
    margin-left: auto;
    margin-right: auto;
    text-align: center;
  }
  #input{
    width:100%;
    height: 100px;
  }
  #layer, #scale{
    height: 2.5em;
    display: inline-block !important;
    margin-bottom: 0 !important;
  }
  #scale{
    width: 5em;
  }
  #list{
    width: 100%;
  }
  .options > label{
    margin: 3px 10px;
    display: inline-block;
  }
  .credit{
    font-size: 80%;
    color: #333;
    line-height: 1.5;
  }
  .credit a, .credit a:any-link{
    color: #0078e7;
    text-decoration: none;
  }
  .picture{
    margin: 4px;
    border: solid 6px #FFF;
    width:180px;
    height:180px;
    display: inline-block;
    transform-origin: center;
  }
  .marked{
    border: solid 6px #0078e7;
  }
  .warning{
    display: none;
  }
  .warning-highlight{
    color: #dd514c;
    font-weight: bold;
  }
  .r1 {transform: rotate(90deg);}
  .r2 {transform: rotate(180deg);}
  .r3 {transform: rotate(270deg);}
  .r0f {transform: scaleX(-1);}
  .r1f {transform: rotate(90deg) scaleX(-1);}
  .r2f {transform: rotate(180deg) scaleX(-1);}
  .r3f {transform: rotate(270deg) scaleX(-1);}
  </style>
</head>

<body>
<div id="main">
<div id="form">
<form class="pure-form">
  <fieldset>
    <!-- Examples come from SAGA Satellites. See https://sagasurvey.org/ -->
    <p><textarea id="input" placeholder="Paste a list of R.A. and Decl."  required>SAGA_SAT    RA  DEC
NGC6181b    247.8399	20.1841
NGC6181c    248.3932	19.9461
NGC6181d    248.0513	19.6957
NGC6181e    247.8755	20.0948
NGC6181f    247.8259	20.2109
NGC6181g    248.1526	19.8095
NGC6181h    248.5809	19.7198
NGC6181i    248.1954	19.8670
NGC6181j    248.2119	19.9001
NGC6181k    248.1636	19.7923
NGC5602b    215.4049	50.3903
NGC5602c    215.4590	50.3884
NGC5602d    214.8035	50.4409
NGC5602e    215.4408	50.5062
NGC5602f    215.5340	50.6674</textarea></p>
    <div class="options">
      <label>
        <select id="layer">
          <option disabled selected value style="display: none;"> --&gt; Choose image source &lt;-- </option>
          <option value="ls-dr9" id="default-layer">Legacy Surveys DR9</option>
          <option value="ls-dr9-model">Legacy Surveys DR9 Model</option>
          <option value="ls-dr9-resid">Legacy Surveys DR9 Residual</option>
          <option value="unwise-neo6">unWISE NEO6 12um Dust Map</option>
          <option value="unwise-cat-model">unWISE Model</option>
          <option value="sdss">SDSS (reprocessed by Legacy Surveys)</option>
          <option value="des-dr1">Dark Energy Survey (DES) DR1</option>
          <option value="hsc-dr2">Hyper Suprime-Cam (HSC) SSP DR2</option>
          <option value="galex">GALEX</option>
          <option value="halpha">Halpha Map</option>
          <option value="sfd">SFD Dust Map</option>
          <option value="vlass1.2">VLASS</option>
          <option value="dr16:sdss">SDSS: DR16</option>
          <option value="poss2ukstu_red:dss">DSS: POSS2/UKSTU Red</option>
          <option value="poss2ukstu_blue:dss">DSS: POSS2/UKSTU Blue</option>
          <option value="poss2ukstu_ir:dss">DSS: POSS2/UKSTU IR</option>
        </select>
      </label>
      <label>
        Side length = <input type="number" id="scale" value="0.75" step="any" min="0.01" max="999" required> arcmin
      </label>
      <label>
        <input type="checkbox" id="enable_marking"/> Enable marking
      </label>
      <label>
        <button id="generate_output" class="pure-button" disabled>Record marks</button>
      </label>
    </div>
    <p class="credit">
      Images retrieved from <a href="https://www.legacysurvey.org/acknowledgment/">Legacy Surveys Sky Viewer</a>, <a href="https://skyserver.sdss.org/dr16/en/tools/chart/listinfo.aspx" title="Sloan Digital Sky Surveys">SDSS</a>, and <a href="https://archive.stsci.edu/cgi-bin/dss_form" title="Digitized Sky Survey">DSS</a>.
      Web interface by <a href="https://yymao.github.io">Yao-Yuan Mao</a>.
      <a href="https://github.com/yymao/decals-image-list-tool/issues">Issues?</a><br>
      <i>
        <span class="warning warning-highlight">Maintainance at NERSC may affect the cutout service of the DESI Legacy Imaging Surveys.<br></span>
        <span class="warning">An <a href="https://viewer.legacysurvey.org">alternative Legacy Surveys Viewer</a> is available, but has no cutout service.<br></span>
        <span class="no-warning">No cutout image shows up?</span>
        Try choosing <u>SDSS: DR16</u> or <u>DSS: *</u> from the dropdown menu.
      </i>
    </p>
  </fieldset>
</form>
</div>
<div id="list"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cash/8.1.0/cash.min.js" integrity="sha512-sgDgZX/GgfD7qSeMjPN/oE9EQgXZJW55FIjdexVT60QerG2gAWhR9QDQEGt3O90Dy9jVcwMWsoTMhLgldIiKXw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
var nersc_is_down = false;
var _cols, _i_ra, _i_dec, _has_mark, _delimiter, _scale, _size, _layer, _source;

(function(){
  var t = new Date().getTime();
  var t_out = Date.parse('9 Jul 2021 10:00:00 PDT');
  var t_back = Date.parse('12 Jul 2021 20:00:00 PDT');
  if ((t >= t_out) && (t < t_back)){
    nersc_is_down = true;
    $("span.warning").show();
  }
})();

const _default_layer = $("#default-layer").attr("value");

const _use_dev = (window.location.hash.substr(1) == "dev")? "-dev" : "";
const _image_urls = {
  "desi": "https://www.legacysurvey.org/viewer" + _use_dev + "/cutout.jpg?ra=${ra}&dec=${dec}&pixscale=${scale}&layer=${layer}&size=180",
  "sdss": "https://skyserver.sdss.org/dr16/SkyServerWS/ImgCutout/getjpeg?TaskName=Skyserver.Chart.List&ra=${ra}&dec=${dec}&scale=${scale}&width=180&height=180",
  "dss": "https://archive.stsci.edu/cgi-bin/dss_search?v=${layer}&r=${ra}&d=${dec}&e=J2000&h=${size}&w=${size}&f=gif"
}
const _link_urls = {
  "desi": "https://www.legacysurvey.org/viewer" + _use_dev + "?ra=${ra}&dec=${dec}&layer=${layer}&zoom=14",
  "sdss": "https://skyserver.sdss.org/dr16/en/tools/chart/navi.aspx?ra=${ra}&dec=${dec}",
  "desi-alt": "https://viewer.legacysurvey.org/?ra=${ra}&dec=${dec}&layer=${layer}&zoom=14",
  "dss": "https://archive.stsci.edu/cgi-bin/dss_search?v=${layer}&r=${ra}&d=${dec}&e=J2000&h=15&w=15&f=gif"
}

const _img_dom_template = "<img class='picture ${marked} ${rot}' title='${title}' src='${img_url}'></img>";
const _linked_img_template = "<a class='plink' href='${link_url}'>${img_dom}</a>";
const _do_rand_rot = (window.location.hash.substr(1) == "randrot");
const _rot_classes = ["", "r1", "r2", "r3", "r0f", "r1f", "r2f", "r3f"];

const parseHeader = function(line){
  var line = line.trim().toLowerCase();
  var has_header = true;

  _delimiter = /\s+/;
  if (line.search(",") > -1) _delimiter = ",";
  _cols = line.split(_delimiter);

  _i_ra = _cols.indexOf("ra");
  _i_dec = _cols.indexOf("dec");

  if (_i_ra == -1 || _i_dec == -1){ // no header
    if (_cols[_cols.length-1] == "true" || _cols[_cols.length-1] == "false"){
      _has_mark = true;
      _cols.pop();
    }
    if (_cols.length == 2){
      _i_ra = 0;
      _i_dec = 1;
    }
    else if (_cols.length > 2){
      _i_ra = 1;
      _i_dec = 2;
    }
    else{
      _has_mark = false;
      $("#list").html("<p>Error! \nPlease make sure the first line is header, and it contains at least \"ra\" and \"dec\". \nOnly supports space/tab/comma-separated tables.</p>");
      return -1;
    }
    _cols = _cols.fill("");
    has_header = false;
  }
  else{ // has header
    if (_cols[_cols.length-1] == "marked"){
      _has_mark = true;
      _cols.pop();
    }
    else{
      _has_mark = false;
    }
  }
  return has_header;
}

const addImage = function(line) {
  var items, img_dom, out, mark;
  items = line.trim().split(_delimiter);
  if (_has_mark) mark = (items.pop()=="true");
  img_dom = _img_dom_template.replace("${img_url}", _image_urls[_source]);
  if ($("#enable_marking").prop("checked")){
    out = img_dom;
  }
  else{
    out = _linked_img_template
      .replace("${link_url}", _link_urls[_source])
      .replace("${img_dom}", img_dom);
  }
  out = out.replace(/\${ra}/g, parseFloat(items[_i_ra]).toString())
           .replace(/\${dec}/g, parseFloat(items[_i_dec]).toString())
           .replace(/\${scale}/g, _scale)
           .replace(/\${size}/g, _size)
           .replace(/\${layer}/g, _layer)
           .replace("${title}", items.map(function(item, i, arr){return _cols[i] + " = " + item;}).join("\n"))
           .replace("${marked}", mark? "marked" : "")
           .replace("${rot}", _do_rand_rot? _rot_classes[Math.floor(Math.random()*_rot_classes.length)] : "");
  $("#list").append(out);
}

const run = function(){
  window.stop();
  var new_layer_source = $("#layer").val().split(":");
  var new_layer = new_layer_source[0];
  var new_source = new_layer_source[1] || "desi";
  var new_size = parseFloat($("#scale").val()).toFixed(7).replace(/0+$/, '');
  var new_scale = (parseFloat($("#scale").val()) / 3).toFixed(7).replace(/0+$/, '');

  if (!_layer){
    if (!new_layer){
        new_layer = _default_layer;
        $("#default-layer").prop("selected", true);
    }
    _layer = new_layer;
  }

  if (!_source) _source = new_source;
  if (!_scale) _scale = new_scale;
  if (!_size) _size = new_size;

  if ($("#list").html() && _source == new_source){
    $(".picture").each(function(){
      var url = $(this).attr("src");
      url = url.replace("="+_layer+"&", "="+new_layer+"&")
               .replace("scale="+_scale+"&", "scale="+new_scale+"&")
               .replace("h="+_size+"&w="+_size, "h="+new_size+"&w="+new_size);
      $(this).attr("src", url);
    });

    $(".plink").each(function(){
      var url = $(this).attr("href");
      url = url.replace("="+_layer+"&", "="+new_layer+"&");
      $(this).attr("href", url);
    });

    _source = new_source;
    _layer = new_layer;
    _scale = new_scale;
    _size = new_size;
  }
  else{
    var lines = $("#input").val().split(/\n/);
    var has_header = parseHeader(lines[0]);
    if (has_header == -1) return;
    if (has_header) lines.shift();
    if (lines[0].replace(/[-\s]/g, "") == "") lines.shift();

    _source = new_source;
    _layer = new_layer;
    _scale = new_scale;
    _size = new_size;

    $("#list").empty();
    lines.forEach(addImage);

    if ($("#enable_marking").prop("checked")){
      $(".picture").on("click", function(){
        $(this).toggleClass("marked");
        $("#generate_output").prop("disabled", false);
      });
      $("#input").prop("readonly", true);
      $("#generate_output").addClass("pure-button-primary");
    }
    else{
      $("#input").prop("readonly", false);
      $("#generate_output").removeClass("pure-button-primary");
      $("#generate_output").prop("disabled", true);
    }
  }
}

function new_run(){
  if (!$("#generate_output").prop("disabled") &&
      !window.confirm("Are you sure you want to reload the images? You cannot recover the marks you made!")){
    $("#enable_marking").prop("checked", !$("#enable_marking").prop("checked"));
    return;
  }
  $("#list").empty();
  run();
}

const output = function(){
  var out = "";
  out += _cols.join("\t");
  out += "\tmarked\n";
  if (out.trim() == "marked") out = "";
  out += $(".picture").map(function(){
    return $(this).attr("title").split(/\n/).map(function(item){
      return item.substring(item.indexOf(" = ")+3);
    }).join("\t") + "\t" + $(this).hasClass("marked");
  }).get().join("\n");
  $("#input").val(out);
  $("#generate_output").prop("disabled", true);
}

$("form").on("submit", function(event){event.preventDefault();});
$("#generate_output").on("click", output);
$("#layer").on("input", run);
$("#scale").on("input", run);
$("#input").on("input", function(){
  $("#list").empty();
  run();
});
$("#enable_marking").on("input", function(){
  if (!$("#generate_output").prop("disabled") &&
      !window.confirm("Are you sure you want to reload the images? You cannot recover the marks you made!")){
    $("#enable_marking").prop("checked", !$("#enable_marking").prop("checked"));
    return;
  }
  $("#list").empty();
  run();
});

$(window).on("beforeunload", function () {
  if (!$("#generate_output").prop("disabled")){
    return "Are you sure you want to close this page? You cannot recover the marks you made!";
  }
});

document.getElementById("layer").focus();

</script>
</body>
</html>
